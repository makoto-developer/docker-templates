# ========================================
# PostgreSQL 18 Docker Makefile
# ========================================

.DEFAULT_GOAL := help

# ----------------------------------------
# Variables
# ----------------------------------------

COMPOSE_FILE := docker-compose.yml
ENV_FILE := .env
ENV_EXAMPLE := .env.example
SERVICE_NAME := local_postgres
BACKUP_DIR := ./backups

# Colors for output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RED    := \033[0;31m
BLUE   := \033[0;34m
NC     := \033[0m

# ----------------------------------------
# Help
# ----------------------------------------

.PHONY: help
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo ""
	@echo "${BLUE}PostgreSQL 18 Docker Management${NC}"
	@echo ""
	@echo "${GREEN}Available commands:${NC}"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  ${GREEN}%-15s${NC} %s\n", $$1, $$2}'
	@echo ""

# ----------------------------------------
# Environment Setup
# ----------------------------------------

.PHONY: setup
setup: ## åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆ.envä½œæˆ â†’ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ â†’ èµ·å‹•ï¼‰
	@echo "${BLUE}ğŸš€ Starting initial setup...${NC}"
	@$(MAKE) check-env
	@$(MAKE) create-dirs
	@$(MAKE) up
	@$(MAKE) wait-db
	@echo "${GREEN}âœ… Setup complete!${NC}"

.PHONY: check-env
check-env: ## .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆãªã‘ã‚Œã°.env.exampleã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
	@if [ ! -f $(ENV_FILE) ]; then \
		echo "${YELLOW}âš ï¸  .env not found. Copying from .env.example...${NC}"; \
		cp $(ENV_EXAMPLE) $(ENV_FILE); \
		echo "${GREEN}âœ… .env created. Please edit it before running 'make up'${NC}"; \
		exit 1; \
	else \
		echo "${GREEN}âœ… .env file exists${NC}"; \
	fi

.PHONY: create-dirs
create-dirs: ## å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
	@echo "${BLUE}ğŸ“ Creating directories...${NC}"
	@mkdir -p data/pgdata data/logs $(BACKUP_DIR)
	@echo "${GREEN}âœ… Directories created${NC}"

# ----------------------------------------
# Container Management
# ----------------------------------------

.PHONY: up
up: check-env ## ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ï¼ˆãƒ‡ã‚¿ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ï¼‰
	@echo "${BLUE}ğŸš€ Starting PostgreSQL container...${NC}"
	@docker compose up -d
	@echo "${GREEN}âœ… Container started${NC}"

.PHONY: down
down: ## ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢
	@echo "${BLUE}ğŸ›‘ Stopping PostgreSQL container...${NC}"
	@docker compose down
	@echo "${GREEN}âœ… Container stopped${NC}"

.PHONY: restart
restart: ## ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•
	@echo "${BLUE}ğŸ”„ Restarting PostgreSQL container...${NC}"
	@docker compose restart
	@echo "${GREEN}âœ… Container restarted${NC}"

.PHONY: start
start: ## åœæ­¢ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹
	@echo "${BLUE}â–¶ï¸  Starting container...${NC}"
	@docker compose start
	@echo "${GREEN}âœ… Container started${NC}"

.PHONY: stop
stop: ## ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ï¼ˆå‰Šé™¤ã¯ã—ãªã„ï¼‰
	@echo "${BLUE}â¸ï¸  Stopping container...${NC}"
	@docker compose stop
	@echo "${GREEN}âœ… Container stopped${NC}"

.PHONY: recreate
recreate: ## ã‚³ãƒ³ãƒ†ãƒŠã‚’å†ä½œæˆï¼ˆè¨­å®šå¤‰æ›´æ™‚ã«ä½¿ç”¨ï¼‰
	@echo "${BLUE}ğŸ”„ Recreating container...${NC}"
	@docker compose up -d --force-recreate
	@echo "${GREEN}âœ… Container recreated${NC}"

# ----------------------------------------
# Monitoring & Logs
# ----------------------------------------

.PHONY: ps
ps: ## ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’è¡¨ç¤º
	@docker compose ps

.PHONY: logs
logs: ## ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
	@docker compose logs -f $(SERVICE_NAME)

.PHONY: logs-tail
logs-tail: ## ãƒ­ã‚°ã®æœ€å¾Œ100è¡Œã‚’è¡¨ç¤º
	@docker compose logs --tail=100 $(SERVICE_NAME)

.PHONY: health
health: ## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
	@echo "${BLUE}ğŸ¥ Checking container health...${NC}"
	@docker compose ps $(SERVICE_NAME)
	@docker inspect --format='{{.State.Health.Status}}' $$(docker compose ps -q $(SERVICE_NAME)) 2>/dev/null || echo "No health status available"

.PHONY: stats
stats: ## ã‚³ãƒ³ãƒ†ãƒŠã®ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ã‚’è¡¨ç¤º
	@docker stats $$(docker compose ps -q $(SERVICE_NAME)) --no-stream

# ----------------------------------------
# Database Operations
# ----------------------------------------

.PHONY: psql
psql: ## PostgreSQLã‚·ã‚§ãƒ«ã«æ¥ç¶š
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -d $$(grep POSTGRES_DB_NAME $(ENV_FILE) | cut -d '=' -f2)

.PHONY: shell
shell: ## ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚·ã‚§ãƒ«ã«å…¥ã‚‹
	@docker compose exec $(SERVICE_NAME) bash

.PHONY: wait-db
wait-db: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
	@echo "${BLUE}â³ Waiting for database to be ready...${NC}"
	@for i in $$(seq 1 60); do \
		if docker compose exec -T $(SERVICE_NAME) pg_isready -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d "=" -f2) > /dev/null 2>&1; then \
			echo "${GREEN}âœ… Database is ready${NC}"; \
			exit 0; \
		fi; \
		sleep 1; \
	done; \
	echo "${RED}âŒ Database failed to start within 60 seconds${NC}"; \
	exit 1

# ----------------------------------------
# Database Management
# ----------------------------------------

.PHONY: backup
backup: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ä½“ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
	@mkdir -p $(BACKUP_DIR)
	@echo "${BLUE}ğŸ’¾ Creating backup...${NC}"
	@docker compose exec -T $(SERVICE_NAME) pg_dumpall -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) | \
		sed -E 's/^(CREATE|ALTER) ROLE/-- &/' > $(BACKUP_DIR)/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "${GREEN}âœ… Backup created in $(BACKUP_DIR)/${NC}"
	@ls -lh $(BACKUP_DIR) | tail -1

.PHONY: restore
restore: ## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒï¼ˆå¼•æ•°: FILE=backup.sqlï¼‰
	@if [ -z "$(FILE)" ]; then \
		echo "${RED}âŒ Error: Please specify FILE=path/to/backup.sql${NC}"; \
		echo "Example: make restore FILE=$(BACKUP_DIR)/backup_20250101_120000.sql"; \
		exit 1; \
	fi
	@echo "${YELLOW}âš ï¸  This will restore database from $(FILE)${NC}"
	@echo "${YELLOW}âš ï¸  Are you sure? [y/N]${NC}" && read ans && [ $${ans:-N} = y ]
	@echo "${BLUE}ğŸ”„ Restoring from backup...${NC}"
	@docker compose exec -T $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) < $(FILE)
	@echo "${GREEN}âœ… Restore complete${NC}"

.PHONY: list-backups
list-backups: ## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "${BLUE}ğŸ“‹ Available backups:${NC}"
	@ls -lh $(BACKUP_DIR)/*.sql 2>/dev/null || echo "No backups found"

# ----------------------------------------
# Database Info
# ----------------------------------------

.PHONY: db-info
db-info: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
	@echo "${BLUE}ğŸ“Š Database Information:${NC}"
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -c "\
		SELECT version();" | head -3
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -c "\l"

.PHONY: db-size
db-size: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºã‚’è¡¨ç¤º
	@echo "${BLUE}ğŸ’¾ Database Sizes:${NC}"
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -c "\
		SELECT \
			datname AS database, \
			pg_size_pretty(pg_database_size(datname)) AS size \
		FROM pg_database \
		WHERE datname NOT IN ('template0', 'template1') \
		ORDER BY pg_database_size(datname) DESC;"

.PHONY: db-connections
db-connections: ## ç¾åœ¨ã®æ¥ç¶šæ•°ã‚’è¡¨ç¤º
	@echo "${BLUE}ğŸ”Œ Active Connections:${NC}"
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -c "\
		SELECT \
			datname, \
			count(*) as connections \
		FROM pg_stat_activity \
		WHERE datname IS NOT NULL \
		GROUP BY datname \
		ORDER BY connections DESC;"

# ----------------------------------------
# Configuration
# ----------------------------------------

.PHONY: config
config: ## PostgreSQLè¨­å®šã‚’è¡¨ç¤º
	@echo "${BLUE}âš™ï¸  PostgreSQL Configuration:${NC}"
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -c "\
		SELECT name, setting, unit, source \
		FROM pg_settings \
		WHERE source != 'default' \
		ORDER BY name;" | head -50

.PHONY: config-file
config-file: ## ä½¿ç”¨ä¸­ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¡¨ç¤º
	@docker compose exec $(SERVICE_NAME) psql -U $$(grep POSTGRES_USER $(ENV_FILE) | cut -d '=' -f2) -c "SHOW config_file;"

# ----------------------------------------
# Cleanup
# ----------------------------------------

.PHONY: clean
clean: ## ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰
	@echo "${RED}âš ï¸  WARNING: This will DELETE all PostgreSQL data!${NC}"
	@echo "${YELLOW}Are you sure? [y/N]${NC}" && read ans && [ $${ans:-N} = y ]
	@echo "${BLUE}ğŸ§¹ Cleaning up...${NC}"
	@$(MAKE) down
	@rm -rf data/pgdata/* data/logs/*
	@echo "${GREEN}âœ… Data cleaned${NC}"

.PHONY: reset-db
reset-db: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤â†’å†ä½œæˆâ†’åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼‰
	@echo "${RED}âš ï¸  WARNING: This will RESET the database (all data will be lost)!${NC}"
	@echo "${YELLOW}Are you sure? [y/N]${NC}" && read ans && [ $${ans:-N} = y ]
	@echo "${BLUE}ğŸ”„ Resetting database...${NC}"
	@docker compose down -v
	@echo "${BLUE}ğŸš€ Recreating container...${NC}"
	@docker compose up -d
	@$(MAKE) wait-db
	@echo "${GREEN}âœ… Database reset complete! Initialization scripts have been executed.${NC}"

.PHONY: destroy
destroy: ## ã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å®Œå…¨å‰Šé™¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰
	@echo "${RED}âš ï¸  WARNING: This will DESTROY everything (containers, volumes, networks)!${NC}"
	@echo "${YELLOW}Are you sure? [y/N]${NC}" && read ans && [ $${ans:-N} = y ]
	@echo "${BLUE}ğŸ’£ Destroying...${NC}"
	@docker compose down -v
	@rm -rf data/pgdata/* data/logs/*
	@echo "${GREEN}âœ… Everything destroyed${NC}"

# ----------------------------------------
# Development
# ----------------------------------------

.PHONY: validate
validate: ## docker-compose.ymlã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
	@echo "${BLUE}ğŸ” Validating docker-compose.yml...${NC}"
	@docker compose config > /dev/null && echo "${GREEN}âœ… Configuration is valid${NC}"

.PHONY: pull
pull: ## æœ€æ–°ã®PostgreSQLã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—
	@echo "${BLUE}â¬‡ï¸  Pulling latest PostgreSQL image...${NC}"
	@docker compose pull
	@echo "${GREEN}âœ… Image pulled${NC}"

.PHONY: prune
prune: ## æœªä½¿ç”¨ã®Dockerãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
	@echo "${YELLOW}This will remove unused Docker resources${NC}"
	@docker system prune -f
	@echo "${GREEN}âœ… Pruned${NC}"
