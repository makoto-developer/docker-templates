services:
  jira:
    image: atlassian/jira-software:${JIRA_VERSION}
    restart: ${JIRA_RESTART_POLICY}
    container_name: ${JIRA_CONTAINER_NAME}
    hostname: ${JIRA_HOSTNAME}
    depends_on:
      jira_postgres:
        condition: service_healthy

    # Environment variables
    environment:
      # JVM settings
      JVM_MINIMUM_MEMORY: ${JVM_MINIMUM_MEMORY}
      JVM_MAXIMUM_MEMORY: ${JVM_MAXIMUM_MEMORY}
      JVM_SUPPORT_RECOMMENDED_ARGS: ${JVM_SUPPORT_RECOMMENDED_ARGS}

      # Database settings
      ATL_JDBC_URL: jdbc:postgresql://${POSTGRES_CONTAINER_NAME}:${POSTGRES_INTERNAL_PORT}/${POSTGRES_DB}
      ATL_JDBC_USER: ${POSTGRES_USER}
      ATL_JDBC_PASSWORD: ${POSTGRES_PASSWORD}
      ATL_DB_DRIVER: ${ATL_DB_DRIVER}
      ATL_DB_TYPE: ${ATL_DB_TYPE}

      # Tomcat settings
      ATL_TOMCAT_PORT: ${JIRA_INTERNAL_PORT}

      # Proxy settings (if behind reverse proxy)
      ATL_PROXY_NAME: ${ATL_PROXY_NAME}
      ATL_PROXY_PORT: ${ATL_PROXY_PORT}
      ATL_TOMCAT_SCHEME: ${ATL_TOMCAT_SCHEME}
      ATL_TOMCAT_SECURE: ${ATL_TOMCAT_SECURE}

      # Timezone & Locale
      TZ: ${TZ}
      LANG: ${LANG}
      LC_ALL: ${LC_ALL}
      LANGUAGE: ${LANGUAGE}

    # Port mapping
    ports:
      - ${JIRA_PORT}:${JIRA_INTERNAL_PORT}

    # Volume mounts for data persistence
    volumes:
      - jira_data:${JIRA_DATA_PATH}

      # Log files
      - ${JIRA_LOG_HOST_PATH}:${JIRA_LOG_PATH}

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://${JIRA_HEALTHCHECK_HOST}:${JIRA_INTERNAL_PORT}${JIRA_HEALTHCHECK_ENDPOINT}"]
      interval: ${JIRA_HEALTHCHECK_INTERVAL}
      timeout: ${JIRA_HEALTHCHECK_TIMEOUT}
      retries: ${JIRA_HEALTHCHECK_RETRIES}
      start_period: ${JIRA_HEALTHCHECK_START_PERIOD}

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: ${JIRA_CPU_LIMIT}
          memory: ${JIRA_MEMORY_LIMIT}
        reservations:
          cpus: ${JIRA_CPU_RESERVATION}
          memory: ${JIRA_MEMORY_RESERVATION}

    # Logging configuration
    logging:
      driver: ${JIRA_LOG_DRIVER}
      options:
        max-size: ${JIRA_LOG_MAX_SIZE}
        max-file: ${JIRA_LOG_MAX_FILE}

    # Networks
    networks:
      - jira_network

  jira_postgres:
    image: postgres:${POSTGRES_VERSION}
    restart: ${POSTGRES_RESTART_POLICY}
    container_name: ${POSTGRES_CONTAINER_NAME}
    hostname: ${POSTGRES_HOSTNAME}

    # Custom PostgreSQL configuration
    command: postgres -c config_file=${POSTGRES_CONFIG_PATH}

    # Environment variables
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PGPORT: ${POSTGRES_INTERNAL_PORT}
      TZ: ${TZ}
      LANG: ${LANG}
      LC_ALL: ${LC_ALL}
      LC_CTYPE: ${LC_CTYPE}
      LC_COLLATE: ${LC_COLLATE}
      POSTGRES_INITDB_ARGS: ${POSTGRES_INITDB_ARGS}

    # Port mapping (optional, for external access)
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_INTERNAL_PORT}

    # Volume mounts for data persistence
    volumes:
      # Database data
      - jira_postgres_data:${POSTGRES_DATA_PATH}

      # Configuration file
      - ${POSTGRES_CONFIG_HOST_PATH}:${POSTGRES_CONFIG_PATH}:ro

      # Initialization scripts
      - ${POSTGRES_INIT_SCRIPTS_HOST_PATH}:${POSTGRES_INIT_SCRIPTS_CONTAINER_PATH}:ro

      # Log files
      - ${POSTGRES_LOG_HOST_PATH}:${POSTGRES_LOG_PATH}

      # Temporary files
      - jira_postgres_tmp:${POSTGRES_TMP_PATH}
      - jira_postgres_run:${POSTGRES_RUN_PATH}

    # Shared memory size
    shm_size: ${POSTGRES_SHM_SIZE}

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: ${POSTGRES_HEALTHCHECK_INTERVAL}
      timeout: ${POSTGRES_HEALTHCHECK_TIMEOUT}
      retries: ${POSTGRES_HEALTHCHECK_RETRIES}
      start_period: ${POSTGRES_HEALTHCHECK_START_PERIOD}

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: ${POSTGRES_CPU_LIMIT}
          memory: ${POSTGRES_MEMORY_LIMIT}
        reservations:
          cpus: ${POSTGRES_CPU_RESERVATION}
          memory: ${POSTGRES_MEMORY_RESERVATION}

    # Logging configuration
    logging:
      driver: ${POSTGRES_LOG_DRIVER}
      options:
        max-size: ${POSTGRES_LOG_MAX_SIZE}
        max-file: ${POSTGRES_LOG_MAX_FILE}

    # Networks
    networks:
      - jira_network

# Named volumes
volumes:
  # Jira data
  jira_data:
    driver: ${VOLUME_DRIVER}

  # PostgreSQL data
  jira_postgres_data:
    driver: ${VOLUME_DRIVER}

  # Temporary file systems
  jira_postgres_tmp:
    driver: ${VOLUME_DRIVER}
    driver_opts:
      type: ${VOLUME_TMPFS_TYPE}
      device: ${VOLUME_TMPFS_DEVICE}
  jira_postgres_run:
    driver: ${VOLUME_DRIVER}
    driver_opts:
      type: ${VOLUME_TMPFS_TYPE}
      device: ${VOLUME_TMPFS_DEVICE}

# Custom network
networks:
  jira_network:
    name: ${NETWORK_NAME}
    driver: ${NETWORK_DRIVER}
    ipam:
      driver: ${NETWORK_IPAM_DRIVER}
      config:
        - subnet: ${NETWORK_SUBNET}
          gateway: ${NETWORK_GATEWAY}
